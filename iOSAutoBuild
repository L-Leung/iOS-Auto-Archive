#!/bin/bash

#------------------------ functions ------------------------
#usage
function FuncUsage() {
	echo "#--------------------------------------------"
	echo "# `basename ${0}`: usage: "
	echo "#		-c NAME å·¥ç¨‹çš„configuration,é»˜è®¤ä¸ºReleaseã€‚"
	echo "#		-o PATH ç”Ÿæˆçš„ipaæ–‡ä»¶è¾“å‡ºçš„æ–‡ä»¶å¤¹ï¼ˆå¿…é¡»ä¸ºå·²å­˜åœ¨çš„æ–‡ä»¶è·¯å¾„ï¼‰é»˜è®¤ä¸ºå·¥ç¨‹æ ¹è·¯å¾„ä¸‹çš„ build/ipa-build æ–‡ä»¶å¤¹ä¸­"
	echo "#		-t NAME éœ€è¦ç¼–è¯‘çš„targetçš„åç§°"
	echo "#		-w      ç¼–è¯‘workspace"
	echo "#		-s NAME å¯¹åº”workspaceä¸‹éœ€è¦ç¼–è¯‘çš„scheme"
	echo "#		-n      ç¼–è¯‘å‰æ˜¯å¦å…ˆcleanå·¥ç¨‹"
	echo "#		-p      å¹³å°æ ‡è¯†ç¬¦"
	echo "#		-u      æ˜¯å¦ä¸Šä¼ è’²å…¬è‹±"
	echo "#--------------------------------------------"
}

#å¢åŠ  build è®¡æ•°
function FuncAddBuild() {
	build_config=${1}
	if [ ${build_config} = DailyBuild -o ${build_config} = Release ]; then
	    echo "Bumping build number..."
	    plist=${project_path}/${build_scheme}/Info.plist

		#increment the build number (ie 115 to 116)
	    buildnum=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "${plist}")
	    if [[ "${buildnum}" == "" ]]; then
	        echo "No build number in $plist"
	        exit 2
	    fi

	    buildnum=$(expr $buildnum + 1)
	    /usr/libexec/Plistbuddy -c "Set CFBundleVersion $buildnum" "${plist}"
	    echo "Bumped build number to $buildnum"

	else
	    echo ${build_config} " build - Not bumping build number."
	fi
}

#------------------------ begin ------------------------
#æ²¡æœ‰è¾“å…¥å‚æ•°
if [ $# -lt 1 ];then
	FuncUsage
	exit 2
fi

#ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯æ–‡ä»¶å¤¹è·¯å¾„
if [ ! -d ${1} ];then
	echo "Error! The first param -- ${1} -- must be a directory."
	exit 2
else
	cd $1
fi

#å·¥ç¨‹ç»å¯¹è·¯å¾„
project_path=$(pwd)

#ç¼–è¯‘çš„configurationï¼Œé»˜è®¤ä¸ºRelease
build_config=Release

param_pattern=":p:nc:o:t:ws::u"
OPTIND=2
should_clean="NO"
should_upload="NO"
platform_id="iPhone"
while getopts ${param_pattern} optname
  do
    case "$optname" in       
	  "n")        
		should_clean="YES"		
        ;;
      "u")
		should_upload="YES"
		;;
      "p")
		tmp_optind=${OPTIND}
		tmp_optname=${optname}
		tmp_optarg=${OPTARG}

		OPTIND=${OPTIND}-1
		if getopts ${param_pattern} optname ;then
			echo  "Error argument value for option $tmp_optname"
			exit 2
		fi
		OPTIND=${tmp_optind}

		platform_id=${tmp_optarg}
		
        ;;
      "c")        
		tmp_optind=${OPTIND}
		tmp_optname=${optname}
		tmp_optarg=${OPTARG}
		OPTIND=${OPTIND}-1
		if getopts ${param_pattern} optname ;then
			echo  "Error argument value for option $tmp_optname"
			exit 2
		fi
		OPTIND=${tmp_optind}

		build_config=${tmp_optarg}
		
        ;;
      "o")
		tmp_optind=${OPTIND}
		tmp_optname=${optname}
		tmp_optarg=${OPTARG}

		OPTIND=${OPTIND}-1
		if getopts ${param_pattern} optname ;then
			echo  "Error argument value for option $tmp_optname"
			exit 2
		fi
		OPTIND=${tmp_optind}


		cd ${tmp_optarg}
		output_path=$(pwd)
		cd ${project_path}

		if [ ! -d ${output_path} ];then
			echo "Error!The value of option o must be an exist directory."
			exit 2
		fi

        ;;
	  "w")
		workspace_name='*.xcworkspace'
		ls ${project_path}/${workspace_name} &>/dev/null
		rtnValue=$?
		if [ $rtnValue = 0 ];then
			build_workspace=$(echo $(basename ${project_path}/$workspace_name))
		else
			echo  "Error!Current path is not a xcode workspace.Please check, or do not use -w option."
			exit 2
		fi
		
        ;;
	  "s")
		tmp_optind=${OPTIND}
		tmp_optname=${optname}
		tmp_optarg=${OPTARG}

		OPTIND=${OPTIND}-1
		if getopts ${param_pattern} optname ;then
			echo  "Error argument value for option $tmp_optname"
			exit 2
		fi
		OPTIND=${tmp_optind}

		build_scheme=${tmp_optarg}
		
        ;;
	  "t")
		tmp_optind=${OPTIND}
		tmp_optname=${optname}
		tmp_optarg=${OPTARG}

		OPTIND=${OPTIND}-1
		if getopts ${param_pattern} optname ;then
			echo  "Error argument value for option $tmp_optname"
			exit 2
		fi
		OPTIND=$tmp_optind

		build_target=$tmp_optarg
		
        ;;

      "?")
        echo "Error! Unknown option $OPTARG"
		exit 2
        ;;
      ":")
        echo "Error! No argument value for option $OPTARG"
		exit 2
        ;;
      *)
      # Should not occur
        echo "Error! Unknown error while processing options"
		exit 2
        ;;
    esac
  done

#buildæ–‡ä»¶å¤¹è·¯å¾„
build_path=${project_path}/build
#ç”Ÿæˆçš„appæ–‡ä»¶ç›®å½•
appdirname=${build_config}-iphoneos
#ç¼–è¯‘åæ–‡ä»¶è·¯å¾„(ä»…å½“ç¼–è¯‘workspaceæ—¶æ‰ä¼šç”¨åˆ°)
compiled_path=${build_path}/${appdirname}

#æ˜¯å¦clean
if [ "$should_clean" = "YES" ];then
	xcodebuild clean -configuration ${build_config}
fi

#ç»„åˆç¼–è¯‘å‘½ä»¤
build_cmd='xcodebuild'

if [ "$build_workspace" != "" ];then
	#ç¼–è¯‘workspace
	if [ "${build_scheme}" = "" ];then
		echo "Error! Must provide a scheme by -s option together when using -w option to compile a workspace."
		exit 2
	fi
	isWorkSpace="YES"
	build_cmd=${build_cmd}' -workspace '${build_workspace}' -scheme '${build_scheme}' -configuration '${build_config}' CONFIGURATION_BUILD_DIR='${compiled_path}' ONLY_ACTIVE_ARCH=NO'

else
	#ç¼–è¯‘project
	build_cmd=${build_cmd}' -configuration '${build_config}
	isWorkSpace="NO"
	if [ "$build_target" != "" ];then
		build_cmd=${build_cmd}' -target '${build_target}
	fi
	
fi

#è¿›å…¥å·¥ç¨‹è·¯å¾„
cd ${project_path}

#å¢åŠ  build è®¡æ•°
FuncAddBuild ${build_config}

#ç¼–è¯‘å·¥ç¨‹
${build_cmd} || exit

#è¿›å…¥buildè·¯å¾„
cd ${build_path}

#åˆ›å»ºipa-buildæ–‡ä»¶å¤¹
if [ -d ./ipa-build ];then
	rm -rf ipa-build
fi
mkdir ipa-build

#appæ–‡ä»¶åç§°
appname=$(basename ./${appdirname}/*.app)
#é€šè¿‡appæ–‡ä»¶åè·å¾—å·¥ç¨‹targetåå­—
target_name=$(echo $appname | awk -F. '{print $1}')
#appæ–‡ä»¶ä¸­Info.plistæ–‡ä»¶è·¯å¾„
app_infoplist_path=${build_path}/${appdirname}/${appname}/Info.plist
#å–ç‰ˆæœ¬å·
bundleShortVersion=$(/usr/libexec/PlistBuddy -c "print CFBundleShortVersionString" ${app_infoplist_path})
#å–buildå€¼
bundleVersion=$(/usr/libexec/PlistBuddy -c "print CFBundleVersion" ${app_infoplist_path})
#å–displayName
displayName=$(/usr/libexec/PlistBuddy -c "print CFBundleName" ${app_infoplist_path})
#IPAåç§°
ipa_name="${target_name}_${platform_id}_v${bundleShortVersion}_${build_config}_${bundleVersion}_$(date +"%Y%m%d")"

#xcrunæ‰“åŒ…
xcrun -sdk iphoneos PackageApplication -v ./${appdirname}/*.app -o ${build_path}/ipa-build/${ipa_name}.ipa || exit

if [ "${output_path}" != "" ];then
	cp ${build_path}/ipa-build/${ipa_name}.ipa $output_path/${ipa_name}.ipa
	echo "Copy ipa file successfully to the path $output_path/${ipa_name}.ipa"
else
	output_path=${build_path}/ipa-build/${ipa_name}.ipa 
fi

echo "ğŸ¾ -------------------------------------------"
echo "ğŸ¾  Project Path : "${project_path}
echo "ğŸ¾  Target : "${build_target}
echo "ğŸ¾  Scheme : "${build_scheme}
echo "ğŸ¾  Configuration : "${build_config}
echo "ğŸ¾  IsWorkSpace : "${isWorkSpace}
echo "ğŸ¾  Clean Before Build : "${should_clean}
echo "ğŸ¾  Appname : "${appname}
echo "ğŸ¾  target_name : "${target_name}
echo "ğŸ¾  Version : v"${bundleShortVersion}" build_"${bundleVersion}
echo "ğŸ¾  displayName : "${displayName}
echo "ğŸ¾  ipa_name : "${ipa_name}
echo "ğŸ¾  output_path : "${output_path}
echo "ğŸ¾ -------------------------------------------"

doneMsg="æ‰“åŒ…å®Œæˆ!"
if [ -f ${output_path} ]; then
	if [ "${should_upload}" = "YES" ]; then
		echo "Begin Upload to pgyer.com... Please wait..."
		curl -F "file=@${output_path}" \
			 -F "uKey=******" \
			 -F "_api_key=******" \
			 -F "password=******" \
			 http://www.pgyer.com/apiv1/app/upload

		doneMsg="ä¸Šä¼ å®Œæˆ!"
	fi
fi

terminal-notifier -title "build ${displayName}" -message "${doneMsg}"






